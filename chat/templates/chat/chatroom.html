{% extends "chat/base.html" %} {% load crispy_forms_tags %}
{% block head_content %}
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
{% endblock head_content %}
{% block content %}
<div class="content-section">

  <div class="container-fluid vh-100">
    <div class="row h-100">
      <!-- User List Sidebar -->
      <div class="col-12 col-md-3 col-lg-2 bg-light border-end d-flex flex-column p-3">
        <div class="d-flex justify-content-between align-items-center mb-4">
          <h5 class="mb-0">Chats</h5>
        </div>
        <div class="list-group overflow-auto">
          {% for chat_data in chats_data %}
          {% if character in chat_data.characters %}
          <a id="{{chat_data.chat.id}}" href="#"
            class="list-group-item list-group-item-action {%if chat_data.chat.is_general%}active{%endif%}">
            <div class="d-flex align-items-center">
              <img style="max-width:40px;max-height:40px"
                src="{% if character == chat_data.characters.0 %}{{ chat_data.characters.1.image.url }}{% else %}{{ chat_data.characters.0.image.url }}{% endif %}"
                class="rounded-circle me-3">
              <div>
                <div class="fw-bold">
                  {% if chat_data.chat.is_general %}
                  General
                  {% else %}
                  {% if character == chat_data.characters.0 %}
                  {{ chat_data.characters.1.name }}
                  {% else %}
                  {{ chat_data.characters.0.name }}
                  {% endif %}
                  {% endif %}
                </div>
              </div>
            </div>
          </a>
          {% endif %}
          {% endfor %}
        </div>
      </div>

      <!-- Chat Area -->
      <div class="col-12 col-md-9 col-lg-10 d-flex flex-column h-100">
        <div class="d-flex justify-content-between align-items-center p-3 border-bottom">
          <div class="d-flex align-items-center">
            <img style="max-height:50px;max-width:50px" src="{{chats_data.0.characters.0.image.url}}"
              class="rounded-circle me-3" alt="User 1">
            <div>
              <h6 class="mb-0">General</h6>
            </div>
          </div>
        </div>
        <div class="chat-messages p-3 flex-grow-1 overflow-auto">
          {% for message in chats_data.0.messages %}
          <div class="message mb-3 {% if character == message.character %}text-end{%endif%}">
            {% if character == message.character %}
            <div class="d-inline-block bg-primary bg-light p-2 rounded">
              <small>{{message.content}}</small>
            </div>
            <img src="{{message.character.image.url}}" class="rounded-circle ms-2"
              style="max-width:40px;max-height:40px">
            {%else%}
            <img src="{{message.character.image.url}}" class="rounded-circle ms-2" style="max-width:40px;max-height:40px">
            <div class="d-inline-block bg-primary bg-light p-2 rounded">
              <small>{{message.content}}</small>
            </div>
            {%endif%}
            <small class="text-muted d-block">{{message.date_added|time:'H:i:s'}}</small>
          </div>
          {% endfor %}
        </div>

        <!-- Message Input -->
        <div class="p-3 border-top">
          <div class="input-group">
            <textarea id="messageInput" class="form-control" placeholder="Type a message..." rows="1"></textarea>
            <button class="btn btn-primary send-message-btn">Send</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  {% block scripts %}
  <script>
    const textarea = document.getElementById('messageInput');

    textarea.addEventListener('input', function () {
      this.style.height = 'auto';
      this.style.height = (this.scrollHeight) + 'px';
    });

    var generalChatId = {{ chats_data.0.chat.id }};
    var currentChatId = {{ chats_data.0.chat.id }};
    var characterId = {{ character.id }};


    const roomSocket = new WebSocket(
      'ws://' + window.location.host + '/ws/room/{{room.name}}/{{character.id}}/'
    );
    roomSocket.onmessage = function (e) {
      const data = JSON.parse(e.data);
      if (data.type == "message_received") {
        if (currentChatId == data.chat_id) {
          var html = "";
          if (characterId == data.character_id) {
            html += '<div class="message mb-3 text-end">';
            html += '  <div class="d-inline-block bg-light p-2 rounded">';
            html += '      <small>' + data.content + '</small>';
            html += '  </div>';
            html += '  <img src="' + data.character_image + '" class="rounded-circle ms-2" style="max-width:40px;max-height:40px">';
          } else {
            html += '<div class="message mb-3">';
            html += '  <img src="' + data.character_image + '" class="rounded-circle ms-2" style="max-width:40px;max-height:40px">';
            html += '  <div class="d-inline-block bg-light p-2 rounded">';
            html += '      <small>' + data.content + '</small>';
            html += '  </div>';
          }
          html += '  <small class="text-muted d-block">' + data.date + '</small>';
          html += '</div>';

          $(".chat-messages")[0].innerHTML += html;
          $(".chat-messages").scrollTop($(".chat-messages")[0].scrollHeight);
        } else {
          //TODO: when message is from other chat
        }
        console.log(data);
      } else {
        console.log(data);
      }
    };
    roomSocket.onclose = function (e) {
      console.error('Chat socket closed unexpectedly');
    };


    const messageInput = $("#messageInput");
    const sendBtn = $(".send-message-btn");
    sendBtn.on("click", function (e) {
      if (!messageInput.val()) {
        return;
      }
      roomSocket.send(
        JSON.stringify({
          "type": "send_message",
          "chat_id": currentChatId,
          "message": messageInput.val(),
        })
      );
      messageInput.val("");
    });



  </script>
  {% endblock scripts %}
</div>
{% endblock content %}