{% extends "chat/base.html" %} {% load crispy_forms_tags %}
{% load extras %}
{% block head_content %}
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
{% endblock head_content %}
{% block content %}
<div class="content-section">

  <div class="container-fluid vh-100">
    <div class="row h-100">
      <!-- User List Sidebar -->
      <div class="col-12 col-md-3 col-lg-2 bg-light border-end d-flex flex-column p-3">
        <div class="d-flex justify-content-between align-items-center mb-4">
          <h5 class="mb-0">Чаты</h5>
        </div>
        <div class="list-group overflow-auto">
          {% for chat_data in chats_data %}
          {% if character in chat_data.characters %}
          <button type="button" id="btn-redirect-chat-{{chat_data.chat.id}}"
            class="list-group-item list-group-item-action {%if chat_data.chat.is_general%}active{%endif%}">
            <div class="d-flex align-items-center">
              <img style="max-width:40px;max-height:40px"
                src="{% if character == chat_data.characters.0 %}{{ chat_data.characters.1.image.url }}{% else %}{{ chat_data.characters.0.image.url }}{% endif %}"
                class="rounded-circle me-3">
              <div class="chat-top-{{chat_data.chat.id}}">
                <div class="fw-bold pb-2">
                  {% if chat_data.chat.is_general %}
                  Общий
                  {% elif chat_data.chat.is_friends %}
                  Друзья
                  {% else %}
                  {% if character == chat_data.characters.0 %}
                  {{ chat_data.characters.1.name }}
                  {% else %}
                  {{ chat_data.characters.0.name }}
                  {% endif %}
                  {% endif %}
                </div>
              </div>
            </div>
          </a>
          {% endif %}
          {% endfor %}
        </div>
      </div>

      <!-- Chat Area -->
      <div class="col-12 col-md-9 col-lg-10 d-flex flex-column h-100">
        <div class="d-flex justify-content-between align-items-center p-3 border-bottom">
          <div class="d-flex align-items-center">
            <img style="max-height:50px;max-width:50px" src="{{chats_data.0.characters.0.image.url}}"
              class="rounded-circle me-3" alt="User 1">
            <div>
              <h6 class="mb-0">Общий</h6>
            </div>
          </div>
        </div>
        <div class="chat-messages p-3 flex-grow-1 overflow-auto">
          {% for message in chats_data.0.messages %}
          <div class="message mb-3 {% if character == message.character %}text-end{%endif%}">
            {% if character == message.character %}
            <div class="d-inline-block bg-primary bg-light p-2 rounded">
              <small>{{message.content}}</small>
            </div>
            <img src="{{message.character.image.url}}" class="rounded-circle ms-2"
              style="max-width:40px;max-height:40px">
            {%else%}
            <img src="{{message.character.image.url}}" class="rounded-circle ms-2" style="max-width:40px;max-height:40px">
            <div class="d-inline-block bg-primary bg-light p-2 rounded">
              <small style="white-space: pre-wrap;">{{message.content}}</small>
            </div>
            {%endif%}
            <small class="text-muted d-block">{{message.date_added|time:'H:i:s'}}</small>
          </div>
          {% endfor %}
        </div>

        <!-- Message Input -->
        <div class="p-3 border-top">
          <div class="input-group">
            <textarea id="messageInput" class="form-control" placeholder={% if is_blocked_by_fighting %}"Битва идет..." disabled{% else %}"Напишите сообщение..."{% endif %} rows="1"></textarea>
            <button class="btn btn-primary send-message-btn" {% if is_blocked_by_fighting %}disabled{% endif %}>Отправить</button>
          </div>
        </div>
        
      </div>
    </div>
  </div>

  {% block scripts %}
  <script>
    var unseenData = {
      {%for chat_data in chats_data%}
      {%if character in chat_data.characters%}{{chat_data.chat.id}}: 0,{%endif%}
      {%endfor%}
    };
    const textarea = document.getElementById('messageInput');

    textarea.addEventListener('input', function () {
      this.style.height = 'auto';
      this.style.height = (this.scrollHeight) + 'px';
    });
    
    const chatMessages = $(".chat-messages");
    const messageInput = $("#messageInput");
    const sendBtn = $(".send-message-btn");

    var generalChatId = {{ chats_data.0.chat.id }};
    var friendsChatId = {{ chats_data.1.chat.id }};
    var currentChatId = {{ chats_data.0.chat.id }};
    var characterId = {{ character.id }};
    var chatIds = [{%for chat_data in chats_data%}{%if character in chat_data.characters%}{{chat_data.chat.id}},{%endif%}{%endfor%}];
    var isBlockedByFighting = '{{is_blocked_by_fighting}}' == 'True';
    var chatIdsDM = [{%for chat_data in chats_data%}{%if characterDM in chat_data.characters %}{{chat_data.chat.id}},{%endif%}{%endfor%}];
    var allMessagesData = {
    {%for chat_data in chats_data%}
    {{chat_data.chat.id}}: 
      [{%for message in chat_data.messages%}
        {content: `{{message.content}}`,
         image: '{{message.character.image.url}}',
         character_id: {{message.character.id}},
         date: '{{message.date_added|time:'H:i:s'}}',
        },
      {%endfor%}],
    {%endfor%}
  };
  var blocked_chat_ids = [{%for chat_data in chats_data%}{%if chat_data.chat.is_blocked %}{{chat_data.chat.id}},{%endif%}{%endfor%}];

    function update_unseen_message(){
      $(".new-messages-count").remove();
      for (var ind in chatIds){
        chatId = chatIds[ind];
        if (unseenData[chatId] == 0){
          continue;
        }
        let html =  '<span class="badge bg-danger rounded-pill translate-middle mt-2 ms-2 new-messages-count">';
            html += unseenData[chatId];
            html += '</span>';
        $('.chat-top-' + chatId)[0].innerHTML += html;
      }
    }

    function addMessage(data){
      var html = "";
      if (characterId == data.character_id) {
        html += '<div class="message mb-3 text-end">';
        html += '  <div class="d-inline-block bg-light p-2 rounded">';
        html += '      <small style="white-space: pre-wrap;">' + data.content + '</small>';
        html += '  </div>';
        html += '  <img src="' + data.image + '" class="rounded-circle ms-2" style="max-width:40px;max-height:40px">';
      } else {
        html += '<div class="message mb-3">';
        html += '  <img src="' + data.image + '" class="rounded-circle ms-2" style="max-width:40px;max-height:40px">';
        html += '  <div class="d-inline-block bg-light p-2 rounded">';
        html += '      <small style="white-space: pre-wrap;">' + data.content + '</small>';
        html += '  </div>';
      }
      html += '  <small class="text-muted d-block">' + data.date + '</small>';
      html += '</div>';

      chatMessages[0].innerHTML += html;
    }

    function updateChatBlockStatus(){
      var status = 0;
      if (blocked_chat_ids.includes(currentChatId)){
        status = 1;
      }else if (isBlockedByFighting){
        status = 2;
      }
      sendBtn.prop("disabled", status != 0);
      messageInput.prop("disabled", status != 0);
      if (status == 1){
        messageInput.attr("placeholder", "Мастер думает...");
      }else if (status == 2){
        messageInput.attr("placeholder", "Битва идет...");
      }else{
        messageInput.attr("placeholder", "Напишите сообщение...");
      }
    }


    const roomSocket = new WebSocket(
      'ws://' + window.location.host + '/ws/room/{{room.name}}/{{character.id}}/'
    );
    roomSocket.onmessage = function (e) {
      const data = JSON.parse(e.data);
      if (data.type == "message_received") {
        if (currentChatId == data.chat_id) {
          addMessage(data);
          chatMessages.scrollTop(chatMessages[0].scrollHeight);
        } else if (data.character_id != characterId) {
          unseenData[data.chat_id] += 1;
          update_unseen_message();
        }
        allMessagesData[data.chat_id].push({content: data.content,
          image: data.image,
          character_id: data.character_id,
          date: data.date,
        });
      } else if(data.type == "update_chat_block_status"){
        blocked_chat_ids = data.blocked_chat_ids;
        updateChatBlockStatus();
      } else if(data.type == "update_is_blocked_by_fighting_status"){
        isBlockedByFighting = data.status;
        updateChatBlockStatus();
      }
      else {
        console.log(data);
      }
    };
    roomSocket.onclose = function (e) {
      console.error('Chat socket closed unexpectedly');
    };

    function sendEvent(){
      if (!messageInput.val()) {
        return;
      }
      if (chatIdsDM.includes(currentChatId) && generalChatId != currentChatId && friendsChatId != currentChatId){
        blocked_chat_ids.push(currentChatId);
        updateChatBlockStatus();
        roomSocket.send(
          JSON.stringify({
            "type": "change_chat_block_status",
            "chat_id": currentChatId,
            "status": true
          })
        );
      }
      roomSocket.send(
        JSON.stringify({
          "type": "send_message",
          "chat_id": currentChatId,
          "message": messageInput.val(),
        })
      );
      messageInput.val("");
      textarea.style.height = 'auto';
      textarea.style.height = (this.scrollHeight) + 'px';
    }

    textarea.addEventListener("keypress", function(e) {
      if (event.key == "Enter" && !e.shiftKey) {
        e.preventDefault();
        sendEvent();
      }
    });

    sendBtn.on("click", function (e) {
      sendEvent();
    });

    function redirectChat(chatId){
      function out(){
        $("#btn-redirect-chat-" + currentChatId)[0].classList.remove("active");
        $("#btn-redirect-chat-" + chatId)[0].classList.add("active");
        currentChatId = chatId;
        chatMessages[0].innerHTML = "";
        for (const ind in allMessagesData[chatId]){
          addMessage(allMessagesData[chatId][ind]);
        }
        unseenData[currentChatId] = 0;
        update_unseen_message();
        updateChatBlockStatus();
      }
      return out;
    }
    for (const ind in chatIds){
      const chatId = chatIds[ind];
      $("#btn-redirect-chat-" + chatId).on("click", redirectChat(chatId));
    }


  </script>
  {% endblock scripts %}
</div>
{% endblock content %}